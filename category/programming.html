<!DOCTYPE html>
<html lang="en">
<head>
        <title>Wisdom Eludes Me - programming</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://quelgar.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Wisdom Eludes Me Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">Wisdom Eludes Me </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="../category/politics.html">politics</a></li>
                                    <li class="active"><a href="../category/programming.html">programming</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../de-suckifying-the-javaneturi-api-with-asymmetric-lenses.html">De-suckifying the java.net.<span class="caps">URI</span> <span class="caps">API</span> with Asymmetric&nbsp;Lenses</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2013-07-03T00:00:00">
                Wed 03 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/scala.html">scala</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info --><p>I find I&#8217;m using the <code>java.net.URI</code> class quite a bit these days. It has two good features: first, it follows the relevant RFCs to the letter; and second, it&#8217;s&nbsp;immutable.</p>
<p>The downside of this class is the <span class="caps">API</span> - it&#8217;s very, well, <em>Java</em>. Actually, it&#8217;s bad even by contemporary Java standards. Lets say we wanted to add an argument to the query string of an existing <span class="caps">URI</span>. Here&#8217;s how you might do it in Java (transliterated to&nbsp;Scala):</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="n">addQueryArgJava</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">)</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">origQuery</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">getQuery</span> <span class="n">eq</span> <span class="kc">null</span><span class="o">)</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="n">u</span><span class="o">.</span><span class="n">getQuery</span> <span class="o">+</span> <span class="sc">&#39;&amp;&#39;</span>
  <span class="k">new</span> <span class="nc"><span class="caps">URI</span></span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">getScheme</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">getAuthority</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">getPath</span><span class="o">,</span> <span class="n">origQuery</span> <span class="o">+</span> <span class="s">&quot;foo=bar&quot;</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">getFragment</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>


<p>Ugh, <em>that&#8217;s</em> going to get old fast. And of course, this primitive string appending probably won&#8217;t do what you want if the original <span class="caps">URI</span> already had a &#8220;foo&#8221;&nbsp;argument.</p>
<p>If we were to implement <span class="caps">URI</span> in Scala, we&#8217;d probably use a case class, in which case the compiler would give us a free <code>copy</code> method to help out with this kind of thing. But we can add a <code>copy</code> method to <code>java.net.URI</code> without too much trouble. Let&#8217;s do away with all the null and -1 unpleasantness while we&#8217;re at&nbsp;it:</p>
<div class="codehilite"><pre><span class="k">import</span> <span class="nn">java.net.<span class="caps">URI</span></span>

<span class="k">implicit</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">RichURI</span><span class="o">(</span><span class="k">val</span> <span class="n">uri</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">scheme</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getScheme</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">userInfo</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getUserInfo</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">host</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getHost</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">port</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getPort</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="nc">None</span> <span class="k">else</span> <span class="nc">Some</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getPort</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">path</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getPath</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">query</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getQuery</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">fragment</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getFragment</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">copy</span><span class="o">(</span><span class="n">scheme</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">scheme</span><span class="o">,</span>
           <span class="n">userInfo</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">userInfo</span><span class="o">,</span>
           <span class="n">host</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">host</span><span class="o">,</span>
           <span class="n">port</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">port</span><span class="o">,</span>
           <span class="n">path</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">path</span><span class="o">,</span>
           <span class="n">query</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">query</span><span class="o">,</span>
           <span class="n">fragment</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">fragment</span><span class="o">)</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="k">new</span> <span class="nc"><span class="caps">URI</span></span><span class="o">(</span>
    <span class="n">scheme</span><span class="o">.</span><span class="n">orNull</span><span class="o">,</span>
    <span class="n">userInfo</span><span class="o">.</span><span class="n">orNull</span><span class="o">,</span>
    <span class="n">host</span><span class="o">.</span><span class="n">orNull</span><span class="o">,</span>
    <span class="n">port</span> <span class="n">getOrElse</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span>
    <span class="n">path</span><span class="o">.</span><span class="n">orNull</span><span class="o">,</span>
    <span class="n">query</span><span class="o">.</span><span class="n">orNull</span><span class="o">,</span>
    <span class="n">fragment</span><span class="o">.</span><span class="n">orNull</span>
  <span class="o">)</span>
<span class="o">}</span>

<span class="n">assert</span><span class="o">(</span><span class="nc"><span class="caps">URI</span></span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;http://www.google.com/&quot;</span><span class="o">).</span><span class="n">copy</span><span class="o">(</span><span class="n">scheme</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;ftp&quot;</span><span class="o">))</span> <span class="o">==</span> <span class="nc"><span class="caps">URI</span></span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;ftp://www.google.com/&quot;</span><span class="o">))</span>
</pre></div>


<p>The code to add the query argument is&nbsp;now:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="n">addQueryArgCopy</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">)</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">query</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">((</span><span class="n">u</span><span class="o">.</span><span class="n">query</span> <span class="n">map</span> <span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="sc">&#39;&amp;&#39;</span><span class="o">)</span> <span class="n">getOrElse</span> <span class="s">&quot;&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;foo=bar&quot;</span> <span class="o">))</span>
<span class="o">}</span>
</pre></div>


<p>Less boilerplate, but still not great. There&#8217;s many ways we&#8217;re could improve on this, but I&#8217;m going to focus on what I think is the best tool for this job: <em>asymmetric lenses</em>.</p>
<p>A Java programmer could intuitively think of an asymmetric lens as the functional programming version of a bean property, without the mutability nightmares. A Scala programmer could think of it as a scalable version of the <code>copy</code> method. An asymmetric lens is basically a means to work with fields within immutable records. I&#8217;m using the terms &#8220;field&#8221; and &#8220;record&#8221; in a very general sense, the &#8220;field&#8221; could be a particular key in a &#8220;record&#8221; that is dictionary map, for example. A lens reifies the mechanics of reading a writing a field into a <em>composable</em> value. As I will attempt to demonstrate, it is the composability of lenses that makes them so&nbsp;powerful.</p>
<p>In the post I&#8217;m just going to cover how lenses can help us with a particular example problem. For more details on what they are and how they work, I highly recommend <a href="http://days2012.scala-lang.org/sites/days2012/files/morris_lenses.pdf">this paper</a> by Tony Morris. It uses Scala and is very easy to follow. All the code from this post, as well as the lens implementation it uses can be found in <a href="https://gist.github.com/quelgar/5819633">this gist</a>.</p>
<p>Defining a lens is pretty straight-forward: you provide a function to read the relevant field, and a function to set the field. As we&#8217;re talking about immutable records, &#8220;setting&#8221; a field means returning a new record which has the new value for the field. Unfortunately, this step tends to require a lot of boilerplate in plain Scala. But as we&#8217;ll see, you at least only need to do the boilerplate once. There has been some work done to automate much of the boilerplate via compiler plugins or macros, but I haven&#8217;t tried these out&nbsp;yet.</p>
<p>So lets define some lenses for the fields of the <code>java.net.URI</code> class. I&#8217;m calling the type of my asymmetric lens <code>@&gt;</code> as I think it looks quite nice with infix notation. You read it as &#8220;record_type @&gt;&nbsp;field_type&#8221;:</p>
<div class="codehilite"><pre><span class="k">object</span> <span class="nc">lens</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">scheme</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">scheme</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">scheme</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">userInfo</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">userInfo</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">userInfo</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">host</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">host</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">host</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">port</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">port</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">port</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">pathString</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">path</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">path</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">queryString</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">query</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">query</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">fragment</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">fragment</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">fragment</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
<span class="o">}</span>
</pre></div>


<p>This is using the <code>copy</code> method listed above. As I said, this very boilerplatey, but now we&#8217;ll never have call the <code>copy</code> method ever again. The <code>Lens</code> constructor takes two arguments: the first is simply a function to return the field value given an instance of the record, and the second is a curried function taking a field value and a record value, and producing a new record value. All of these particular lenses return an optional value, simply because each element of a <span class="caps">URI</span> is optional (an empty string is a valid&nbsp;<span class="caps">URI</span>!).</p>
<p>So here&#8217;s how we&#8217;d use a lens to add to the query&nbsp;string:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="n">addQueryArgLensString</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">)</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">lens</span><span class="o">.</span><span class="n">queryString</span><span class="o">.</span><span class="n">modify</span><span class="o">(</span><span class="n">u</span><span class="o">)(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">((</span><span class="n">x</span> <span class="n">map</span> <span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="sc">&#39;&amp;&#39;</span><span class="o">)</span> <span class="n">getOrElse</span> <span class="s">&quot;&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;foo=bar&quot;</span><span class="o">))</span>
<span class="o">}</span>
</pre></div>


<p>Hmm, not really an improvement over the copy method, is it? But we can do better. Let&#8217;s make another lens for the query string, but this time we&#8217;ll parse the query string to make a <code>URI @&gt; Map[String, String]</code>:</p>
<div class="codehilite"><pre><span class="c1">// note - not production quality parsing</span>
<span class="k">private</span> <span class="k">val</span> <span class="n">regex</span> <span class="k">=</span> <span class="s">&quot;&quot;&quot;([^=&amp;]+)=([^&amp;]+)&amp;?&quot;&quot;&quot;</span><span class="o">.</span><span class="n">r</span>
<span class="k">def</span> <span class="n">parse</span><span class="o">(</span><span class="n">queryString</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">queryString</span> <span class="n">map</span> <span class="o">{</span> <span class="n">q</span> <span class="k">=&gt;</span>
  <span class="o">(</span><span class="n">regex</span><span class="o">.</span><span class="n">findAllMatchIn</span><span class="o">(</span><span class="n">q</span><span class="o">)</span> <span class="n">map</span> <span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="o">(</span><span class="mi">2</span><span class="o">))).</span><span class="n">toMap</span>
<span class="o">}</span> <span class="n">getOrElse</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span>
<span class="k">def</span> <span class="n">toQueryString</span><span class="o">(</span><span class="n">pairs</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)])</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="nc">None</span> <span class="k">else</span> <span class="nc">Some</span><span class="o">(</span><span class="n">pairs</span> <span class="n">map</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot;$k=$v&quot;</span>
<span class="o">}</span> <span class="n">mkString</span> <span class="s">&quot;&amp;&quot;</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">lens</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">query</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="kt">@&gt;</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span>
    <span class="n">r</span> <span class="k">=&gt;</span> <span class="n">parse</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">query</span><span class="o">),</span>
    <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">query</span> <span class="k">=</span> <span class="n">toQueryString</span><span class="o">(</span><span class="n">v</span><span class="o">))</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div>


<p>How does this help? Well, we can also define a lens that will &#8220;focus&#8221; on a given key of any <code>Map</code>:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="n">mapLens</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">key</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">@&gt;</span> <span class="nc">Option</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Lens</span><span class="o">(</span>
  <span class="k">_</span> <span class="n">get</span> <span class="n">key</span><span class="o">,</span>
  <span class="k">_</span> <span class="n">map</span> <span class="o">(</span><span class="n">v</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="k">_:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])</span> <span class="o">+</span> <span class="o">(</span><span class="n">key</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">))</span> <span class="n">getOrElse</span> <span class="o">(</span><span class="k">_</span> <span class="o">-</span> <span class="n">key</span><span class="o">)</span>
<span class="o">)</span>
</pre></div>


<p>And then we compose these two lenses, to focus not just on the query string, but the &#8220;foo&#8221; argument within the query string (I have written compose as <code>&gt;=&gt;</code>):</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="n">addQueryArgLens</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">)</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">lens</span><span class="o">.</span><span class="n">query</span> <span class="o">&gt;=&gt;</span> <span class="n">mapLens</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">)</span> <span class="n">set</span> <span class="o">(</span><span class="n">u</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;bar&quot;</span><span class="o">))</span>
<span class="o">}</span>
</pre></div>


<p>This avoids having to manipulate strings or manually copy objects, and if the query string already has a &#8220;foo&#8221; argument, its value will simply be replaced. Let&#8217;s do the comparison for removing a query string&nbsp;argument:</p>
<div class="codehilite"><pre><span class="cm">/**</span>
<span class="cm"> * Java version of removing query argument &quot;foo&quot;, if it is present.</span>
<span class="cm"> */</span>
<span class="k">def</span> <span class="n">removeFooArgJava</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">)</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">re</span> <span class="k">=</span> <span class="s">&quot;foo=([^&amp;]+)&amp;?&quot;</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">pattern</span>
  <span class="k">val</span> <span class="n">matcher</span> <span class="k">=</span> <span class="n">re</span><span class="o">.</span><span class="n">matcher</span><span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">getQuery</span> <span class="n">eq</span> <span class="kc">null</span><span class="o">)</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="n">u</span><span class="o">.</span><span class="n">getQuery</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">newQuery</span> <span class="k">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">replaceFirst</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)</span>
  <span class="k">new</span> <span class="nc"><span class="caps">URI</span></span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">getScheme</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">getAuthority</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">getPath</span><span class="o">,</span> <span class="k">if</span> <span class="o">(</span><span class="n">newQuery</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="kc">null</span> <span class="k">else</span> <span class="n">newQuery</span><span class="o">,</span> <span class="n">u</span><span class="o">.</span><span class="n">getFragment</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">removeFooArgLens</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">)</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">lens</span><span class="o">.</span><span class="n">query</span> <span class="o">&gt;=&gt;</span> <span class="n">mapLens</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">)</span> <span class="n">set</span> <span class="o">(</span><span class="n">u</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>


<p>And naturally, this new &#8220;foo&#8221; lens can be composed with others. So if, say, the <span class="caps">URI</span> was the field of some other case class, all you have to do is define a lens for that field and then compose it with whatever you need, for&nbsp;example:</p>
<div class="codehilite"><pre><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Example</span><span class="o">(</span><span class="n">href</span><span class="k">:</span> <span class="kt"><span class="caps">URI</span></span><span class="o">,</span>
  <span class="c1">// more fields</span>
<span class="o">)</span>

<span class="k">val</span> <span class="n">hrefLens</span><span class="k">:</span> <span class="kt">Example</span> <span class="kt">@&gt;</span> <span class="kt"><span class="caps">URI</span></span> <span class="o">=</span> <span class="nc">Lens</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">href</span><span class="o">,</span> <span class="n">v</span> <span class="k">=&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">href</span> <span class="k">=</span> <span class="n">v</span><span class="o">))</span>
<span class="k">val</span> <span class="n">example</span> <span class="k">=</span> <span class="nc">Example</span><span class="o">(</span><span class="k">new</span> <span class="nc"><span class="caps">URI</span></span><span class="o">(</span><span class="s">&quot;…&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">exampleWithFoo</span><span class="k">:</span> <span class="kt">Example</span> <span class="o">=</span> <span class="n">hrefLens</span> <span class="o">&gt;=&gt;</span> <span class="n">lens</span><span class="o">.</span><span class="n">query</span> <span class="o">&gt;=&gt;</span> <span class="n">mapLens</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">)</span> <span class="n">set</span> <span class="o">(</span><span class="n">u</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;bar&quot;</span><span class="o">))</span>
</pre></div>


<p>I really hope the Scala team can one day include lenses in the Scala standard library. Scala&#8217;s motto is &#8220;a Scalable language&#8221;. Well, the <code>copy</code> method definitely doesn&#8217;t scale&nbsp;well:</p>
<div class="codehilite"><pre><span class="k">val</span> <span class="n">exampleWithFoo</span><span class="k">:</span> <span class="kt">Example</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">href</span> <span class="k">=</span> <span class="n">example</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span>
  <span class="n">query</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">toQueryString</span><span class="o">(</span><span class="n">parse</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">query</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">)))</span>
<span class="o">))</span>
</pre></div>


<p>And in real code, record/field hierarchies can get a lot more complex than&nbsp;this.</p>
<p>There&#8217;s more cool stuff that can be done with lenses. A <em>partial</em> asymmetric lens can be convenient for manipulating values that may be absent. And lenses work really well with the state monad. See the above referenced <a href="http://days2012.scala-lang.org/sites/days2012/files/morris_lenses.pdf">paper</a> for&nbsp;details.</p><p>There are <a href="../de-suckifying-the-javaneturi-api-with-asymmetric-lenses.html#disqus_thread">comments</a>.</p>                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../deploying-a-play-application-on-ubuntu.html" rel="bookmark"
                           title="Permalink to Deploying a Play Application on Ubuntu">Deploying a Play Application on&nbsp;Ubuntu</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-03-28T00:00:00">
                Thu 28 March 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/scala.html">scala</a><a href="../tag/programming.html">programming</a><a href="../tag/play.html">play</a></p>
</footer><!-- /.post-info -->                <p>The more I use the <a href="http://www.playframework.com">Play Web Framework</a>, the more I like it. The &#8220;dev mode&#8221; is great, compiling everything that&#8217;s changed on the fly, including the statically checked routes and templates. But sooner or later we want to deploy our app for&nbsp;reals.</p>
<p>The <code>dist</code> target will package up your app into a zip file with a simple shell script to launch it. That&#8217;s fine as far as it goes, but of course I want to run it as a proper service that starts automatically when the machine boots and can be easily shutdown and restarted. My ...</p>
                <a class="readmore" href="../deploying-a-play-application-on-ubuntu.html">read more</a>
                <p>There are <a href="../deploying-a-play-application-on-ubuntu.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../do-you-get-referential-transparency.html" rel="bookmark"
                           title="Permalink to Do You Get Referential Transparency?">Do You Get Referential&nbsp;Transparency?</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2012-07-15T00:00:00">
                Sun 15 July 2012
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/scala.html">scala</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>Do you get referential transparency? I mean, really <em>get</em> it? I thought I did, but I recently gained a deeper appreciation for what it&nbsp;means.</p>
<p>Referential transparency is also commonly referred to as &#8220;pure&#8221; functional programming. I understood this to mean that the code lacked side effects like performing I/O or mutating state, and this seems to be a common understanding. But referential transparency can actually be defined quite precisely and succinctly (although I believe agreement with this definition would be far from&nbsp;universal):</p>
<blockquote>
<p>If replacing expression x by its value produces the same behaviour, then x is referentially ...</p></blockquote>
                <a class="readmore" href="../do-you-get-referential-transparency.html">read more</a>
                <p>There are <a href="../do-you-get-referential-transparency.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../applying-applicative-functors-in-scala.html" rel="bookmark"
                           title="Permalink to Applying Applicative Functors in Scala">Applying Applicative Functors in&nbsp;Scala</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2011-09-02T00:00:00">
                Fri 02 September 2011
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/scala.html">scala</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>A chap named ittayd has written a nice <a href="http://www.tikalk.com/incubator/blog/functional-programming-scala-rest-us">gentle tutorial on functional programming in Scala</a>. My only minor complaint is that he calls the applicative functor &#8220;sequential application&#8221; function <code>apply</code>. While this is a logical choice, in Scala <code>apply</code> is used everywhere to implement plain old function application, so it could lead to confusion. I think it&#8217;s better to call it <code>&lt;*&gt;</code>, as in Haskell. Read&nbsp;on.</p>
<p>I found the tutorial interesting because it talks a bit about applicative functors, and how to give them a nice syntax in Scala. The one thing that has bugged me about applicatives is ...</p>
                <a class="readmore" href="../applying-applicative-functors-in-scala.html">read more</a>
                <p>There are <a href="../applying-applicative-functors-in-scala.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../a-variation-on-scalas-either-type.html" rel="bookmark"
                           title="Permalink to A Variation on Scala’s Either Type">A Variation on Scala&#8217;s Either&nbsp;Type</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2011-05-03T00:00:00">
                Tue 03 May 2011
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/scala.html">scala</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>I&#8217;ve been using Scala&#8217;s <code>Either</code> type a bit recently, and found a
couple of minor annoyances with it. So as a learning exercise I tried to
make a variation of <code>Either</code>, and this is what I came up with. I also
wanted to experiment with syntax a little. See what you&nbsp;think.</p>
<p><code>Either</code> is a disjunctive type with two possible values: a <em>left</em> and a <em>right</em>.
It places no meaning at all on left or right, but 99% of its uses in practice
involve putting normal, expected values in right, and errors or other
&#8220;exceptional&#8221; values in left ...</p>
                <a class="readmore" href="../a-variation-on-scalas-either-type.html">read more</a>
                <p>There are <a href="../a-variation-on-scalas-either-type.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../ceylon-interesting-for-the-wrong-reasons.html" rel="bookmark"
                           title="Permalink to Ceylon: Interesting For The Wrong Reasons">Ceylon: Interesting For The Wrong&nbsp;Reasons</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2011-04-15T00:00:00">
                Fri 15 April 2011
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/ceylon.html">ceylon</a><a href="../tag/flameage.html">flameage</a><a href="../tag/java.html">java</a><a href="../tag/scala.html">scala</a></p>
</footer><!-- /.post-info -->                <p>A couple of days ago, Gavin King announced that he is leading a team at RedHat that&#8217;s creating a new <span class="caps">JVM</span> language called Ceylon. See <a href="http://in.relation.to/19161.lace">here</a> for most of what is known so far. The stated motivation, in a nutshell is that they like Java very much, but it has deficiencies that are preventing progress in key areas, and they are generally feeling &#8220;frustrated&#8221;. They don&#8217;t have a complete compiler yet, but they&#8217;re working on it, and I get the impression RedHat is pretty serious about&nbsp;it.</p>
<p>Gavin King&#8217;s slides provide a fascinating insight into the ...</p>
                <a class="readmore" href="../ceylon-interesting-for-the-wrong-reasons.html">read more</a>
                <p>There are <a href="../ceylon-interesting-for-the-wrong-reasons.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../more-thoughts-on-apple-and-java.html" rel="bookmark"
                           title="Permalink to More Thoughts on Apple and Java">More Thoughts on Apple and&nbsp;Java</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-10-27T00:00:00">
                Wed 27 October 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/java.html">java</a><a href="../tag/apple.html">apple</a><a href="../tag/speculation.html">speculation</a></p>
</footer><!-- /.post-info -->                <p>A few more points that occurred to me, following up on my last&nbsp;post.</p>
<h1>Whither the&nbsp;Mouse?</h1>
<p>Since its inception in 1984, the Mac user interface has obviously been
designed for desktop computers with a mouse and a keyboard. When notebook
computers came along and we wanted to be able to use them without carrying a
mouse everywhere, or without even a flat, stable surface to put the mouse on,
they had to emulate the mouse as best they could. This may now be&nbsp;reversing.</p>
<p>In the announcement of Mac <span class="caps">OS</span> X Lion, there was great
emphasis placed on the ...</p>
                <a class="readmore" href="../more-thoughts-on-apple-and-java.html">read more</a>
                <p>There are <a href="../more-thoughts-on-apple-and-java.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../java-and-the-mac.html" rel="bookmark"
                           title="Permalink to Java and the Mac">Java and the&nbsp;Mac</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-10-23T00:00:00">
                Sat 23 October 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/java.html">java</a><a href="../tag/apple.html">apple</a><a href="../tag/speculation.html">speculation</a></p>
</footer><!-- /.post-info -->                <p>So Apple has quietly announced that it is <a href="http://developer.apple.com/library/mac/#releasenotes/Java/JavaSnowLeopardUpdate3LeopardUpdate8RN/NewandNoteworthy/NewandNoteworthy.html%23//apple_ref/doc/uid/TP40010380-CH4-SW1">deprecating its support for Java on the Mac</a>. The wording was (not uncharacteristically for situations like this) a bit vague on the details of what this means. I think two things are definite: 1) Apple will continue to support Java 6 on Snow Leopard until it reaches end of life; which I think happens when the <span class="caps">OS</span> <em>after</em> Lion is publicly released. 2) Apple will not port Java 7+ to the Mac. The main unresolved question is whether Java 6 will be supported on Lion. My guess is that it will be ...</p>
                <a class="readmore" href="../java-and-the-mac.html">read more</a>
                <p>There are <a href="../java-and-the-mac.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../scalas-missing-monad.html" rel="bookmark"
                           title="Permalink to Scala’s Missing Monad">Scala&#8217;s Missing&nbsp;Monad</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-09-30T00:00:00">
                Thu 30 September 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/programming.html">programming</a><a href="../tag/scala.html">scala</a><a href="../tag/haskell.html">haskell</a></p>
</footer><!-- /.post-info -->                <p>I&#8217;ve been writing more and more pure functional code in both Scala and Java
recently. An issue I found myself running into quite often is this: say you
have a function that sometimes returns no results (e.g. looking up a key in a
map). A common way to deal with that in Scala is to return an <code>Option</code>:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="n">foo</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</pre></div>


<p>Simple enough. But then a typical use of such a function is to map it over all members of a&nbsp;collection:</p>
<div class="codehilite"><pre><span class="k">val</span> <span class="n">strings</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">foo</span> <span class="k">_</span><span class="o">)</span>
</pre></div>


<p>What ...</p>
                <a class="readmore" href="../scalas-missing-monad.html">read more</a>
                <p>There are <a href="../scalas-missing-monad.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../cocoa-vs-haskell.html" rel="bookmark"
                           title="Permalink to Cocoa vs Haskell">Cocoa vs&nbsp;Haskell</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-01-08T00:00:00">
                Fri 08 January 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/programming.html">programming</a><a href="../tag/cocoa.html">cocoa</a><a href="../tag/haskell.html">haskell</a></p>
</footer><!-- /.post-info -->                <p>So here&#8217;s the deal - if you want to write a Mac <span class="caps">GUI</span> app, you want to use the Cocoa framework. As a practical system for writing desktop <span class="caps">GUI</span> apps, the Cocoa stack simply has no equal anywhere. Part of what makes Cocoa so great is the Objective-C language, which adds a very flexible and dynamic <span class="caps">OOP</span> system on top of standard&nbsp;C.</p>
<p>Objective-C turned out to be a great match for creating desktop GUIs. It&#8217;s obviously a general-purpose language, but for general programming it would be no where near my first choice. My first choice right now would ...</p>
                <a class="readmore" href="../cocoa-vs-haskell.html">read more</a>
                <p>There are <a href="../cocoa-vs-haskell.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../some-simple-scala-null-tricks.html" rel="bookmark"
                           title="Permalink to Some Simple Scala Null Tricks">Some Simple Scala Null&nbsp;Tricks</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-12-16T00:00:00">
                Wed 16 December 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/programming.html">programming</a><a href="../tag/scala.html">scala</a></p>
</footer><!-- /.post-info -->                <p>Scala code often needs to deal with null references, unfortunately. Such is
the price of Java interoperability. One of my favourite utility methods&nbsp;is:</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="o">?[</span><span class="kt">A</span> <span class="k">&lt;:</span> <span class="kt">AnyRef</span><span class="o">](</span><span class="n">ref</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="n">eq</span> <span class="kc">null</span><span class="o">)</span> <span class="nc">None</span> <span class="k">else</span> <span class="nc">Some</span><span class="o">(</span><span class="n">ref</span><span class="o">)</span>

<span class="c1">// e.g.</span>
<span class="k">val</span> <span class="n">value</span> <span class="k">=</span> <span class="o">?(</span><span class="n">javaCallThatMayReturnNull</span><span class="o">()).</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">defaultValue</span><span class="o">)</span>
</pre></div>


<p>Scala 2.8 offers this using <code>Option(ref)</code> instead of
<code>?(ref)</code>. However, I can&#8217;t figure out why the Scala 2.8 method
accepts non-reference values as&nbsp;well.</p>
<p>Another simple thing that may come in handy is an extractor for non-null&nbsp;values:</p>
<div class="codehilite"><pre><span class="k">object</span> <span class="nc">NotNull</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">unapply</span><span class="o">[</span><span class="kt">A</span> <span class="k">&lt;:</span> <span class="kt">AnyRef</span><span class="o">](</span><span class="n">ref</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref ...</span></pre></div>
                <a class="readmore" href="../some-simple-scala-null-tricks.html">read more</a>
                <p>There are <a href="../some-simple-scala-null-tricks.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../the-fsf-doesnt-care-if-theyre-lonely.html" rel="bookmark"
                           title="Permalink to The FSF Doesn’t Care if They’re Lonely">The <span class="caps">FSF</span> Doesn&#8217;t Care if They&#8217;re&nbsp;Lonely</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-07-06T00:00:00">
                Mon 06 July 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/programming.html">programming</a><a href="../tag/rant.html">rant</a><a href="../tag/open-source.html">open source</a></p>
</footer><!-- /.post-info -->                <p>Daniel Jalkut, a leading light of the Mac developer community recently <a href="http://www.red-sweater.com/blog/825/getting-pretty-lonely">blogged about</a> the <a href="http://www.gnu.org/licenses/licenses.html#GPL"><span class="caps">GPL</span></a> and some of consequences of it for collaborative software development. I agree with what he says, and I dislike how the <span class="caps">GPL</span> limits collaboration in a number of ways. But I thought it might be useful to go over the background and objectives of the&nbsp;<span class="caps">GPL</span>.</p>
<p>There&#8217;s an important thing to remember when talking about the <span class="caps">GPL</span>: the impact, good or bad, on the practicalities of software development have nothing to do with its objectives. The authors of the <span class="caps">GPL</span>, the <a href="http://www.fsf.org/">Free Software Foundation ...</a></p>
                <a class="readmore" href="../the-fsf-doesnt-care-if-theyre-lonely.html">read more</a>
                <p>There are <a href="../the-fsf-doesnt-care-if-theyre-lonely.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../project-euler-problem-8.html" rel="bookmark"
                           title="Permalink to Project Euler Problem 8">Project Euler Problem&nbsp;8</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-06-01T23:00:00">
                Mon 01 June 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/scala.html">scala</a><a href="../tag/programming.html">programming</a><a href="../tag/project-euler.html">project euler</a></p>
</footer><!-- /.post-info -->                <p>I guess I should warn that these Project Euler posts have <strong>spoilers</strong>, in case you want to try the problems yourself ☺. My Scala solution to <a href="http://projecteuler.net/problem=8">problem 8</a>:</p>
<div class="codehilite"><pre><span class="k">val</span> <span class="n">input</span> <span class="k">=</span> <span class="s">&quot;73167176531330624919225119674426574742355349194934&quot;</span> <span class="o">+</span>
  <span class="s">&quot;96983520312774506326239578318016984801869478851843&quot;</span> <span class="o">+</span>
  <span class="s">&quot;85861560789112949495459501737958331952853208805511&quot;</span> <span class="o">+</span>
  <span class="s">&quot;12540698747158523863050715693290963295227443043557&quot;</span> <span class="o">+</span>
  <span class="s">&quot;66896648950445244523161731856403098711121722383113&quot;</span> <span class="o">+</span>
  <span class="s">&quot;62229893423380308135336276614282806444486645238749&quot;</span> <span class="o">+</span>
  <span class="s">&quot;30358907296290491560440772390713810515859307960866&quot;</span> <span class="o">+</span>
  <span class="s">&quot;70172427121883998797908792274921901699720888093776&quot;</span> <span class="o">+</span>
  <span class="s">&quot;65727333001053367881220235421809751254540594752243&quot;</span> <span class="o">+</span>
  <span class="s">&quot;52584907711670556013604839586446706324415722155397&quot;</span> <span class="o">+</span>
  <span class="s">&quot;53697817977846174064955149290862569321978468622482&quot;</span> <span class="o">+</span>
  <span class="s">&quot;83972241375657056057490261407972968652414535100474&quot;</span> <span class="o">+</span>
  <span class="s">&quot;82166370484403199890008895243450658541227588666881&quot;</span> <span class="o">+</span>
  <span class="s">&quot;16427171479924442928230863465674813919123162824586&quot;</span> <span class="o">+</span>
  <span class="s">&quot;17866458359124566529476545682848912883142607690042&quot;</span> <span class="o">+</span>
  <span class="s">&quot;24219022671055626321111109370544217506941658960408&quot;</span> <span class="o">+</span>
  <span class="s">&quot;07198403850962455444362981230987879927244284909188&quot;</span> <span class="o">+</span>
  <span class="s">&quot;84580156166097919133875499200524063689912560717606&quot;</span> <span class="o">+</span>
  <span class="s">&quot;05886116467109405077541002256983155200055935729725&quot;</span> <span class="o">+</span>
  <span class="s">&quot;71636269561882670428252483600823257530420752963450&quot;</span>

<span class="k">val</span> <span class="n">digits</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">asDigit</span><span class="o">).</span><span class="n">toArray</span>

<span class="k">def</span> <span class="n">multiply</span><span class="o">(</span><span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">digits</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">5</span><span class="o">)</span>
    <span class="o">.</span><span class="n">foldLeft</span><span class="o">(</span><span class="mi">1</span><span class="o">)(</span><span class="k">_</span><span class="o">*</span><span class="k">_</span><span class="o">)</span>

<span class="k">val</span> <span class="n">multiples</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">rec</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">multiply</span><span class="o">(</span><span class="n">n</span><span class="o">),</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">digits</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">5</span><span class="o">)</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">rec</span><span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">))</span>
    <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">mult</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">rec ...</span></pre></div>
                <a class="readmore" href="../project-euler-problem-8.html">read more</a>
                <p>There are <a href="../project-euler-problem-8.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../project-euler-in-scala.html" rel="bookmark"
                           title="Permalink to Project Euler in Scala">Project Euler in&nbsp;Scala</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-06-01T17:19:00">
                Mon 01 June 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/scala.html">scala</a><a href="../tag/programming.html">programming</a><a href="../tag/project-euler.html">project euler</a></p>
</footer><!-- /.post-info -->                <p><a href="http://projecteuler.net/">Project Euler</a> is a bunch of mathematical/programming problems. I&#8217;ve been trying to improve my <a href="http://www.scala-lang.org/">Scala</a> skills by using it on some of the Euler problems. I&#8217;m trying to use functional programming styles as much as possible. My solutions definitely haven&#8217;t been very optimized, but I am learning, which is the&nbsp;aim.</p>
<p><strong><a href="http://projecteuler.net/problem=1">Euler Problem&nbsp;1</a></strong></p>
<blockquote>
<p>If we list all the natural numbers below 10 that are multiples of 3 or 5, we get 3, 5, 6 and 9. The sum of these multiples is 23.  Find the sum of all the multiples of 3 or 5 below ...</p></blockquote>
                <a class="readmore" href="../project-euler-in-scala.html">read more</a>
                <p>There are <a href="../project-euler-in-scala.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../logging-vs-string-construction.html" rel="bookmark"
                           title="Permalink to Logging vs String Construction">Logging vs String&nbsp;Construction</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2006-10-17T00:00:00">
                Tue 17 October 2006
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/java.html">java</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>A classic logging problem in Java is&nbsp;this:</p>
<div class="codehilite"><pre><span class="n">logger</span><span class="o">.</span><span class="na">finest</span><span class="o">(</span><span class="n">expensiveStringConstruction</span><span class="o">());</span>
</pre></div>


<p>The problem with this is that even when the logger&#8217;s level is above <span class="caps">FINEST</span> and the message is not logged, the message string must still be constructed. In cases where constructing the string involves a lot of work, your code can be slowed down significantly even when logging is off. The standard solution is like&nbsp;so:</p>
<div class="codehilite"><pre><span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na"><span class="caps">FINEST</span></span><span class="o">))</span> <span class="o">{</span>
  <span class="n">logger</span><span class="o">.</span><span class="na">finest</span><span class="o">(</span><span class="n">expensiveStringConstruction</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>


<p>By adding the <code>if</code> statement around the logging, the expensive string construction is only done if the message is actually going to be used ...</p>
                <a class="readmore" href="../logging-vs-string-construction.html">read more</a>
                <p>There are <a href="../logging-vs-string-construction.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../xml-vs-streams.html" rel="bookmark"
                           title="Permalink to XML vs Streams"><span class="caps">XML</span> vs&nbsp;Streams</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2006-09-26T00:00:00">
                Tue 26 September 2006
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/java.html">java</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>Ever get the feeling that <span class="caps">XML</span> sometimes makes things harder than they need to be? One of the problems that I and others have run into is that when parsing <span class="caps">XML</span> using <span class="caps">SAX</span> (or, in my case, using <span class="caps">JAXB</span> to unmarshall <span class="caps">XML</span>, which uses <span class="caps">SAX</span> under the hood) from an InputStream, the stream is always closed after the parsing is complete. This is surprising behaviour in Java, because you&#8217;re not supposed to close streams you don&#8217;t own. This can be a problem when <a href="http://weblogs.java.net/blog/kohsuke/archive/2005/07/socket_xml_pitf.html">using network sockets</a> or when you want to write two or more unrelated <span class="caps">XML</span> documents ...</p>
                <a class="readmore" href="../xml-vs-streams.html">read more</a>
                <p>There are <a href="../xml-vs-streams.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../javas-clone-mechanism-is-teh-suq.html" rel="bookmark"
                           title="Permalink to Java’s clone mechanism is teh suq">Java&#8217;s clone mechanism is teh&nbsp;suq</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2006-03-27T00:00:00">
                Mon 27 March 2006
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/java.html">java</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>Doing cloning properly in Java is way harder than it should be. I thought I knew all the traps, but recently found yet another. In a nutshell, making inner classes cloneable is almost always a bad idea. The reason is that inner classes have an internal reference to an instance of their enclosing class, which is implicitly final and can&#8217;t be changed as part of a clone. For&nbsp;example:</p>
<div class="codehilite"><pre><span class="kd">class</span> <span class="nc">Outer</span> <span class="kd">implements</span> <span class="n">Cloneable</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">Inner</span> <span class="n">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Inner</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">Outer</span> <span class="n">clone</span> <span class="o">=</span> <span class="o">(</span><span class="n">Outer</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
            <span class="n">clone</span><span class="o">.</span><span class="na">inner</span> <span class="o">=</span> <span class="o">(</span><span class="n">Inner</span><span class="o">)</span><span class="n">inner</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span> <span class="c1">// A.</span>
            <span class="c1">// Cloned inner still ...</span></pre></div>
                <a class="readmore" href="../javas-clone-mechanism-is-teh-suq.html">read more</a>
                <p>There are <a href="../javas-clone-mechanism-is-teh-suq.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../handling-invocationtargetexception.html" rel="bookmark"
                           title="Permalink to Handling InvocationTargetException">Handling&nbsp;InvocationTargetException</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2005-12-23T00:00:00">
                Fri 23 December 2005
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/java.html">java</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>A quick hint on handling <code>java.lang.reflect.InvocationTargetException</code>.</p>
<p>This sucker is thrown whenever you invoke a method via reflection (typically via <code>Method.invoke</code>), and that method throws any sort of exception. So it doesn&#8217;t indicate a problem with the reflection mechanism, it is simply how the reflection mechanism notifies you of exceptions thrown by the method you&nbsp;called.</p>
<p>Whenever you catch this exception (and you will have to catch it at some level), the first thing you should do is call <code>getCause()</code>. This returns the exception thrown from the method that was invoked via reflection, and that&#8217;s ...</p>
                <a class="readmore" href="../handling-invocationtargetexception.html">read more</a>
                <p>There are <a href="../handling-invocationtargetexception.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../how-not-to-catch-exceptions.html" rel="bookmark"
                           title="Permalink to How Not to Catch Exceptions">How Not to Catch&nbsp;Exceptions</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2005-12-23T00:00:00">
                Fri 23 December 2005
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/lachlan-odea.html">Lachlan O'Dea</a>
        </address>
        <p>In <a href="../category/programming.html">programming</a>. </p>
<p>tags: <a href="../tag/java.html">java</a><a href="../tag/programming.html">programming</a></p>
</footer><!-- /.post-info -->                <p>When it comes to bad Java practices, top of my list would have to be catching exceptions like&nbsp;this:</p>
<div class="codehilite"><pre><span class="k">try</span> <span class="o">{</span>
   <span class="c1">// stuff - anything really</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// maybe log it if you&#39;re lucky</span>
<span class="o">}</span>
</pre></div>


<p>This is usually done because the &#8220;stuff&#8221; throws more than one kind of checked exception, and the code to handle each case is the same. So what&#8217;s wrong with it? The biggest problem is that this not only catches the checked exceptions you&#8217;re interested in, but also all <code>RuntimeException</code>s. The vast majority of <code>RuntimeException</code>s are only thrown from buggy code, and catching them ...</p>
                <a class="readmore" href="../how-not-to-catch-exceptions.html">read more</a>
                <p>There are <a href="../how-not-to-catch-exceptions.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                                                    </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://www.scala-lang.org/">Scala</a></li>
                                                    <li><a href="http://www.playframework.com">Play Framework</a></li>
                                                    <li><a href="http://java.oracle.com/">Java</a></li>
                                                    <li><a href="http://www.apple.com/">Apple</a></li>
                                                    <li><a href="http://www.giantitp.com/comics/oots0001.html">The Order of the Stick</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://quelgar.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://twitter.com/quelgar">Twitter</a></li>
                                                    <li><a href="https://github.com/quelgar">GitHub</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'wisdom-eludes-me';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>